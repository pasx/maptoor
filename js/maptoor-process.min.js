maptoor.process={Filter:function(){this.fieldName="",this.weight=0,this.cutOut=function(t){return!0}},Filters:function(t,e){var r=[];r.push({}),r[0].filter=t;var i=[];this.currentFilters=null,this.options=e,this.add=function(t,e,i){var a=new maptoor.process.Filter;a.fieldName=t,a.weight=e||a.weight,a.cutOut=i||a.cutOut;var n={};n.filter=a,r.push(n),this.currentFilters=null,this.getFilters()},this.getFilters=function(){i=[];var t=Enumerable.From(r),e=(r.length,t.Where("$.filter.weight==0").Count());if(e>0){var a=(1-t.Sum("$.filter.weight"))/e;t.ForEach(function(t){var e=t.filter.weight>0?t.filter.weight:a;t.w=e})}return t.ForEach(function(t){var e=new maptoor.process.Filter;e.fieldName=t.filter.fieldName,e.weight=t.w,e.cutOut=t.filter.cutOut,i.push(e)}),this.currentFilters=i,i},this.filter=function(t,e){var r=this.options,i=this.setDistanceAndHeading(t,e,r.latField,r.lngField),a=this.currentFilters||this.getFilters(),n=[];$.each(i[r.root],function(t,e){var r={};r.data=e,n.push(r),r.keep=!0,$.each(a,function(r,i){n[t].keep=n[t].keep&&i.cutOut(e)})});var o=Enumerable.From(n).Where("$.keep").Select("$.data");if(o.Any()){n=[];var s=[];$.each(a,function(t,e){var r={};r.filter=e,s.push(r);var i=o.Max("$['"+e.fieldName+"']");r.max=i>=1?i:1}),o.ForEach(function(t,e){var r={};r.data=t,n.push(r);var i=[],o=0;$.each(a,function(e,r){score=t[r.fieldName]/s[o++].max,score=Math.pow(10*score,3)/1e3,score*=r.weight,i.push(score)}),n[e].scores=i}),$.each(n,function(t,e){var r=e.scores;e.data.score=Enumerable.From(r).Sum()});var c=Enumerable.From(n).GroupBy("$.data.direction");n=[],c.ForEach(function(t,e){if(t.Any()){var r=t.OrderBy("$.data.score").Take(1).Select("$.data").ToArray();n.push(r[0])}});var u=r?r.numSigns:4,h=[];return n.length>0&&(h=Enumerable.From(n).OrderBy("$.score").Take(u).ToArray()),h}},this.setDistanceAndHeading=function(t,e,r,i){var a=this.options,n=a.latLngMapCenter,o=a.boxHeight,s=a.boxWidth;return $.each(t[a.root],function(t,e){var c=new google.maps.LatLng(e[r],e[i]),u=maptoor.spatial.mapDistance(n,c),h=maptoor.spatial.heading(n,c);u=Math.round(u),e.distcenter=u;var l=maptoor.spatial.getDistOnRect(u,s,o,h);e.distance=l;var p="";h>=22.5&&h<67.5?p=maptoor.signs.TR:h>=67.5&&h<112.5?p=maptoor.signs.CR:h>=112.5&&h<157.5?p=maptoor.signs.BR:h>=157.5&&h<=180||h>=-180&&h<-157.5?p=maptoor.signs.BC:h>=-157.5&&h<-112.5?p=maptoor.signs.BL:h>=-112.5&&h<-67.5?p=maptoor.signs.CL:h>=-67.5&&h<-22.5?p=maptoor.signs.TL:h>=-22.5&&h<22.5&&(p=maptoor.signs.TC),e[a.directionField]=p,e[a.headingField]=h}),t}}};