document.registerElement("sign-p");var maptoor=maptoor||{};maptoor.signs={TL:"tl",TC:"tc",TR:"tr",CL:"cl",CR:"cr",BL:"bl",BC:"bc",BR:"br",Sign:function(i,t,s){this.rowId=i,this.type=t,this.visible=!0,this.signsOptions=s,this.div={},this.innerDiv={},this.textDiv={},this.textP={},this.distP={},this.iconImg={},this.makeLatLng=function(i){return new google.maps.LatLng(this.data[this.signsOptions.latField],this.data[this.signsOptions.lngField])},this.makeSignHtml=function(){var i=this.signsOptions,t=this.rowId,s=this.type,n="sign-"+s;this.div=$("<div/>",{id:n,class:"sign"}),this.div.appendTo("#"+t),this.innerDiv=$('<div class="sign-inner sign-arrow-'+s+'" />'),this.innerDiv.appendTo(this.div);var o=this;this.innerDiv.click(function(){o.signsOptions.signClickCallback(o)}),this.innerDiv.on("taphold",function(){o.signsOptions.signLongClickCallback(o)}),this.textDiv=$('<div class="sign-text"/>'),this.textDiv.appendTo(this.innerDiv),i.showIcon&&(this.iconImg=$('<img class="sign-icon sign-icon-'+s+'" src="'+i.iconUrl+'" />'),this.iconImg.appendTo(this.textDiv)),this.textP=$('<sign-p class="sign-noselect"/>'),this.textP.appendTo(this.textDiv),this.signsOptions.showDistance&&(this.distP=$('<sign-p class="sign-dist sign-noselect"/>'),this.distP.appendTo(this.textDiv))},this.set=function(i,t,s,n){if(this.data=n,this.textP.html(t),s&&this.signsOptions.showDistance){var o=this.signsOptions.convertDistance(s)||"";this.distP.html(o)}this.showHide()},this.showHide=function(i){0==i?this.innerDiv.hide():(this.innerDiv.fadeIn("slow"),this.innerDiv.css("display","table"))}},Cache:function(){var i=new utils.caching.SimpleCache(function(i,t){return maptoor.spatial.containBounds(t,i)});this.get=function(t){return i.get(t)},this.contains=function(t){return i.contains(t)},this.count=function(){return i.count},this.add=function(t,s){return i.add(t,s)},this.clear=function(){i.clear()}},Signs:function(i,t){this.mapbox=$("#"+i),this.mapOverlay=$("#map-overlay"),this.signsOptions=t,this.signsDataProvider={},this.signs=[],this.eSigns=function(){$("<div/>",{id:"map-overlay"}).appendTo("#"+i),$("<div/>",{id:"sign-row-top",class:"row-top"}).appendTo("#map-overlay"),$("<div/>",{id:"sign-row-center",class:"row-center"}).appendTo("#map-overlay"),$("<div/>",{id:"sign-row-bottom",class:"row-bottom"}).appendTo("#map-overlay");var t=this.signs,s=this.signsOptions;return t.push(new maptoor.signs.Sign("sign-row-top",maptoor.signs.TL,s)),t.push(new maptoor.signs.Sign("sign-row-top",maptoor.signs.TC,s)),t.push(new maptoor.signs.Sign("sign-row-top",maptoor.signs.TR,s)),t.push(new maptoor.signs.Sign("sign-row-center",maptoor.signs.CL,s)),t.push(new maptoor.signs.Sign("sign-row-center",maptoor.signs.CR,s)),t.push(new maptoor.signs.Sign("sign-row-bottom",maptoor.signs.BL,s)),t.push(new maptoor.signs.Sign("sign-row-bottom",maptoor.signs.BC,s)),t.push(new maptoor.signs.Sign("sign-row-bottom",maptoor.signs.BR,s)),$.each(t,function(i,t){t.makeSignHtml.call(t)}),Enumerable.From(t)}.call(this);var s=function(i){var t=this.eSigns.Where('$.type=="'+i+'"').FirstOrDefault();return t||console.log("sign not found for type:"+i+"!"),t};this.clear=function(){$.each(this.signs,function(i,t){t.showHide(!1)})},this.set=function(i,t,n,o){s.call(this,i).set(i,t,n,o)},this.setPadding=function(i,t,s,n){i&&this.mapOverlay.css({"padding-top":i+"px"}),t&&this.mapOverlay.css({"padding-top":t+"px"}),s&&this.mapOverlay.css({"padding-top":s+"px"}),n&&this.mapOverlay.css({"padding-top":n+"px"})},this.refresh=function(i){this.clear();var t=function(i,t){if(t){var s=i.signsOptions;$.each(t,function(t,n){var o=n[s.directionField],e=n[s.nameField],a=n[s.distanceField];i.set(o,e,a,n)})}},s=this;this.signsDataProvider.getData(i,function(i){t(s,i)})}},SignsOptions:function(){this.numSigns=4,this.isMetric=!1,this.showText=!0,this.showIcon=!1,this.showMainUnit=!1,this.showSecondaryUnit=!0,this.iconUrl="",this.showDistance=!0,this.root="geonames",this.nameField="name",this.distanceField="distance",this.headingField="heading",this.directionField="direction",this.populationField="population",this.populationMin=1e3,this.populationZeroIsNoData=!0,this.distUnitMile="M",this.distUnitKm="Km",this.distUnitMeter="m",this.distUnitYard="yd",this.minBoxSize=10,this.userName="",this.maxRows=500,this.map={},this.latField="lat",this.lngField="lng",this.excludedNameParts=[],this.latLngMapCenter={},this.boxHeight=0,this.boxWidth=0,this.maxRadius=300;var i=this;this.signClickCallback=function(t){i.map.setCenter(t.makeLatLng())},this.signLongClickCallback=function(t){testLong(t.makeLatLng(),i.map,i.options)},this.signSwipeToCenterCallback=function(t,s){testLong(s.makeLatLng(),i.map,i.options)},this.urlBase="http://api.geonames.org/findNearbyPlaceNameJSON?lat=#LAT#&lng=#LNG#&radius=#RADIUS#&maxRows=#MAXROWS#&style=long&username=#USER#";var t=function(i,t,s){var n=t||0,o=i.toFixed(n);return s&&(o+=s),o},s=function(i){var t=10*Math.floor(.1*i),s=i-t;return s>10/3&&(t+=5),s>20/3&&(t+=5),t},n=function(i){var t=Math.floor(i);return t+=i-t>.5?1:.5};this.meterToMiles=function(i){var s=i*(1/1609.344);return t(s,0,this.showMainUnit?this.distUnitMile:null)},this.meterToYards=function(i){var n=1.0936*i;if(!(n<50))return n<100&&(n=100),n=s(n),t(n,0,this.showSecondaryUnit?this.distUnitYard:null)},this.meterToKilometers=function(i){var s=.001*i,o=(s=s<10?n(s):s)<10&&s!=Math.round(s)?1:0;return t(s,o,this.showMainUnit?this.distUnitKm:null)},this.meterToMeters=function(i){var n=i;if(!(n<50))return n<100&&(n=100),n=s(n),t(n,0,this.showSecondaryUnit?this.distUnitMeter:null)},this.distanceConversion=function(i){return this.isMetric?this.meterToKilometers(i):this.meterToMiles(i)},this.distanceSecondaryConversion=function(i){return this.isMetric?this.meterToMeters(i):this.meterToYards(i)},this.convertDistance=function(i){if(0!=i){var t=this.isMetric?1e3:1609.344,s=this.boxHeight;if((this.boxWidth+s)/2<5*t||!(i<=1.25*t))return(this.isMetric?i<950:i<1609.344*.45)?this.distanceSecondaryConversion(i):this.distanceConversion(i)}}},SignsDataProvider:function(i){var t=new maptoor.signs.Cache;this.options=i,this.getDataOverride=null,this.request="",this.makeRadius=function(t){var s=maptoor.spatial.getBoundsWidth(t),n=(s=Math.max(s,i.minBoxSize))/2*1.414213562*.01;return n>i.maxRadius&&(i.maxRadius<=0&&console.log("#ERR: options.maxRadius<=0"),ratio=i.maxRadius/n,t=maptoor.spatial.expandBounds(t,ratio),n=i.maxRadius),n},this.makeUrl=function(i,t,s){var n=this.options,o=n.urlBase;return o=o.replace("#LAT#",i.lat()),o=o.replace("#LNG#",i.lng()),o=o.replace("#USER#",n.userName),o=o.replace("#MAXROWS#",n.maxRows),o=o.replace("#RADIUS#",s),DEBUG&&console.log(o),this.request=o,o},this.getData=function(i,s){this.request="",this.storeBounds(i);var n=maptoor.spatial.expandBounds(i,5),o=this.makeRadius(n),e=this.getFilterDist(3*o/5),a=this.options,r=new maptoor.process.Filters(e,a);this.addPopulationFilter(r),this.addDictionaryFilter(r);var h=t.get(i);if(h){var l=h.data;return l=r.filter(l,i),void s(l)}var c=a.latLngMapCenter,d=this.makeUrl(c,n,o),p=function(o){o||console.log("undefined JSON"),o[a.root]||console.log("badly formed JSON: "+o.substring(0,256)),t.add(n,o);var e=r.filter(o,i);s(e)};if(this.getDataOverride){var u=this.getDataOverride(i);p(u)}else $.ajax({url:d,type:"GET",success:function(i){p(i)},error:function(i,t,n){var o="Error retrieving data";DEBUG&&(o="\n"+i.status+" "+n),alert(o);var e={};e.error=o,s(e)}})},this.addDictionaryFilter=function(i){var t=this.options.excludedNameParts;if(t&&0!=t.length){var s=this.options;i.add(s.nameField,0,function(i){var n=i[s.nameField],o=!0;return $.each(t,function(i,t){if(n.indexOf(t)>=0)return o=!1,!1}),o})}},this.addPopulationFilter=function(i){var t=this.options;0!=t.populationMin&&i.add(t.populationField,.3,function(i){var s=i[t.populationField];return!(0!=s||!t.populationZeroIsNoData)||s>t.populationMin})},this.storeBounds=function(i){var t=this.options,s=i.getCenter(),n=maptoor.spatial.getBoundsHeight(i),o=maptoor.spatial.getBoundsWidth(i);t.latLngMapCenter=s,t.boxHeight=n,t.boxWidth=o},this.getFilterDist=function(i){var t=this.options,s=new maptoor.process.Filter;return s.fieldName=t.distanceField,s.weight=t.populationMin>0?.7:1,s.cutOut=function(s){var n=s[t.distanceField];return 0!=n&&(n*=.01)<=i},s}}};